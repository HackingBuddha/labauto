# .github/workflows/ci.yml
name: LabAuto CI

on:
  push:
    branches: [main]
  pull_request:

jobs:
  test-and-build:
    runs-on: ubuntu-latest
    steps:
    # 1) Checkout source code
    - name: Checkout source
      uses: actions/checkout@v4

    # 2) Setup Micromamba environment
    - name: Setup Micromamba
      uses: mamba-org/setup-micromamba@v1
      with:
        micromamba-version: "latest"
        environment-file: env.yml
        environment-name: labauto
        init-shell: bash
        cache-environment: true
        cache-downloads: true
        post-cleanup: 'none'

    # 3) Lint and format check
    - name: Lint and Format Check with Ruff
      shell: bash -l {0}
      run: |
        ruff check .
        ruff format --check .

    # 4) Download the large data file
    - name: Download ClinVar Data
      shell: bash -l {0}
      run: |
        echo "Downloading ClinVar data..."
        # --- FIX #1: Use the correct, real URL for the data file ---
        wget -q -O clinvar_20250615.vcf.gz "https://ftp.ncbi.nlm.nih.gov/pub/clinvar/vcf_GRCh38/clinvar_20250615.vcf.gz"

    # 5) Generate features & train model
    - name: Generate Features & Train Model
      shell: bash -l {0}
      run: |
        # --- FIX #2: Add the required --out argument for the feature engineering script ---
        python scripts/feature_engineering.py clinvar_20250615.vcf.gz --out data/clinvar_features.parquet
        python scripts/train.py

    # 6) Run actual tests
    - name: Run Tests with Pytest
      shell: bash -l {0}
      run: |
        pytest

    # 7) Upload the trained model as an artifact
    - name: Upload Model Artifact
      uses: actions/upload-artifact@v4
      with:
        name: trained-model
        # --- FIX #3: Use the correct path where train.py saves the model ---
        path: models/model.joblib